<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONOTE - Cloud Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic:wght@700&family=Jost:wght@900&display=swap" rel="stylesheet">
    <style>
        /* --- „Çπ„Çø„Ç§„É´„Éª„Éá„Ç∂„Ç§„É≥ (ÂÖ®Ê©üËÉΩÁ∂≠ÊåÅ) --- */
        body{margin:0;font-family:"Sawarabi Gothic";font-weight:700;background:#fff;overflow:hidden;}
        header { font-family: "Jost"; font-size: 34px; padding: 12px 24px; border-bottom: 1px solid #eee; background: #fff; display: flex; align-items: baseline; gap: 10px; }
        .sync-status { font-size: 10px; font-family: "Sawarabi Gothic"; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #888; font-weight: 700; line-height: 1; transform: translateY(-2px); }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-btn { background: #4285F4; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(66,133,244,0.3); }
        .layout{display:flex;height:calc(100vh - 70px);width: 100vw;}
        .left{width:15%; min-width:180px; border-right:1px solid #eee; padding:16px; background:#fafafa; overflow:auto; box-sizing: border-box;}
        .main{width:50%; min-width:350px; padding:28px; overflow:auto; border-right:1px solid #eee; box-sizing: border-box;}
        .right{width:35%; min-width:250px; padding:16px; background:#fcfcfc; overflow:auto; box-sizing: border-box;}
        .active-cat-title { text-align: left; font-size: 28px; margin-bottom: 24px; color: #333; border-left: 8px solid #f6f6f6; padding: 0 0 0 16px; line-height: 1.2; }
        .panel{background:#eee;border-radius:14px;padding:10px;margin-bottom:12px;display:flex;gap:8px; flex-wrap: wrap;}
        .addBtn{background:#555;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
        
        .mainBtn, .nameBtn, .saveNoteBtn, .folderBtn, .previewBtn { background:#fff; border:2px solid #000; border-radius:12px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; position:relative !important; text-align:left; font-family:inherit; display: flex; align-items: center; gap: 8px; word-break: break-all; white-space: normal; overflow-wrap: break-word; }
        .mainBtn { padding-right: 34px; margin: 4px; width: calc(100% - 8px); box-sizing: border-box;}
        
        .emoji-disp { font-size: 1.2em; cursor: pointer; transition: 0.2s; padding: 2px; border-radius: 4px; flex-shrink: 0; }
        .emoji-picker { position: absolute; top: 40px; left: 0; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .emoji-item { cursor: pointer; font-size: 18px; text-align: center; padding: 4px; border-radius: 6px; }
        .custom-emoji-area { grid-column: span 4; border-top: 1px solid #eee; padding-top: 8px; margin-top: 4px; display: flex; justify-content: center; }
        .custom-input { width: 100% !important; padding: 6px !important; margin: 0 !important; text-align: center; font-size: 14px; height: 32px; border: 2px solid #ddd !important; }
        
        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàÂè≥‰∏äÂõ∫ÂÆöÔºâ */
        .actionGroup { position:absolute; top: 2px; right: 2px; display:flex; flex-direction:row; gap:2px; opacity:0; transition:0.2s; z-index:20; }
        .mainBtn:hover .actionGroup, .nameBtn:hover .actionGroup, .folderBtn:hover .actionGroup, .previewBtn:hover .actionGroup, .fullContent-wrapper:hover .actionGroup, .term-wrapper:hover .actionGroup, .term-desc:hover .actionGroup, .fullContent:hover .actionGroup { opacity:1; }
        
        .miniBtn { padding:2px 6px; border:2px solid #000; background:#fff; border-radius:6px; font-size:12px; cursor:pointer; line-height:1.2; }
        .active-cat { background: #f6f6f6 !important; border-color: #000; }
        .cat-item-wrapper { position: relative; margin-bottom: 12px; }
        .move-btns { display: flex; gap: 6px; padding-left: 8px; margin-top: 2px; }
        .arrowBtn { background: transparent; border: none; cursor: pointer; font-size: 16px; padding: 0 4px; color: #aaa; transition: 0.2s; }
        .arrowBtn:hover { color: #000; }
        .folder{background:#f6f6f6; border:none; border-radius:16px; padding:14px; margin-bottom:16px; display: block; overflow: visible; position: relative;}
        textarea,input{width:100%;border:2px solid #000;border-radius:12px;padding:8px;margin-top:6px;box-sizing:border-box;font-family:inherit;font-weight:700;}
        .inlineEdit { border:2px solid #000; border-radius:8px; padding:4px; font-weight:700; width:80%; margin:0; }
        .fullContent-wrapper { position: relative; width: 100%; margin: 8px 0; }
        .fullContent { font-size:14px; white-space:pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; cursor: pointer; min-height:1.2em; position:relative;}
        .previewBtn { width:100%; margin-top:4px; padding:8px 34px 8px 12px; font-size:13px; border:none; text-align: left;}
        .charRow{display:flex; flex-direction: column; gap:12px; margin-top:12px;}
        .charItem { position: relative; margin-bottom: 10px; }
        .term-wrapper { margin-bottom: 12px; width: 100%; box-sizing: border-box; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; display: block; position: relative; }
        .termBtn { width: auto; border: none; background: transparent; border-radius: 0; padding: 4px 0px; font-size: 15px; color: #333; display: block; text-align: left; }
        .term-desc { font-size: 14px; white-space: pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; margin: 4px 0 0 0; cursor: pointer; position: relative; line-height: 1.4; color: #444; font-weight: 700; text-align: left; display: block; width: 100%; max-width: 100%; word-break: break-all; min-height: 1.2em; box-sizing: border-box;}
    </style>
</head>
<body onclick="window.closeAllPickers()">

<div id="auth-overlay">
    <header style="border:none; font-size: 48px;">SONOTE</header>
    <button class="login-btn" onclick="window.login()">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</button>
</div>

<header>SONOTE<span id="header-status" class="sync-status">Connecting...</span></header>

<div class="layout">
    <div class="left"><div class="panel"><button class="addBtn" onclick="window.addCategory()">ÔºãËøΩÂä†</button></div><div id="catList"></div></div>
    <div class="main" id="main" ondragover="window.initDragOver(event)"></div>
    <div class="right" id="glossary"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPYhwYgFtr5pp8PYjtUMfCP541NoAmmcM",
        authDomain: "sonote-cba11.firebaseapp.com",
        projectId: "sonote-cba11",
        storageBucket: "sonote-cba11.firebasestorage.app",
        messagingSenderId: "41068766709",
        appId: "1:41068766709:web:be0782bb13591ebc74acbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    let docRef = null;

    window.data = [];
    let activeCatId = null;
    let addingItemFolderId = null;
    let activePickerId = null;
    let customAreaVisible = false;
    const EMOJI_LIST = ["üìù","üìÅ","üë§","üí°","üî•","‚≠ê","üîë","üåà","üõ°Ô∏è","üß™","üìú","üó∫Ô∏è","üé≠","üíé","‚åõ"];

    // --- Ë™çË®ºÁ≥ª ---
    window.login = () => signInWithPopup(auth, provider).catch(err => alert(err.message));

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            docRef = doc(db, "users", user.uid);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().sonoteData;
                    if (JSON.stringify(window.data) !== JSON.stringify(cloudData)) {
                        window.data = cloudData || [];
                        window.render();
                        document.getElementById('header-status').innerText = "Cloud";
                    }
                }
            });
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { window.data = docSnap.data().sonoteData || []; }
            window.render();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    window.save = async function() {
        if (!docRef) return;
        try {
            await setDoc(docRef, { sonoteData: window.data }, { merge: true });
            document.getElementById('header-status').innerText = "Cloud Synced";
        } catch (e) { document.getElementById('header-status').innerText = "Sync Error"; }
    };

    // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Á≥ª ---
    window.closeAllPickers = () => { if(activePickerId !== null) { activePickerId = null; customAreaVisible = false; window.render(); } };
    window.togglePicker = (e, id) => { e.stopPropagation(); activePickerId = (activePickerId === id) ? null : id; customAreaVisible = false; window.render(); };
    window.toggleCustomArea = () => { customAreaVisible = !customAreaVisible; window.render(); };
    window.initDragOver = (e) => e.preventDefault();

    window.setEmoji = (type, id, emoji) => {
        if(!emoji) return;
        if(type === 'cat'){
            const target = window.data.find(c => c.id === id);
            if(target) target.emoji = emoji;
        } else {
            const cat = window.data.find(c => c.id === activeCatId);
            if(cat){
                const folder = cat.folders.find(f => f.id === id);
                if(folder) folder.emoji = emoji;
            }
        }
        activePickerId = null; customAreaVisible = false; window.save(); window.render();
    };

    window.getEmojiPickerHtml = (type, targetId) => {
        return `<div class="emoji-picker" onclick="event.stopPropagation()">
            ${EMOJI_LIST.map(e => `<div class="emoji-item" onclick="window.setEmoji('${type}', ${targetId}, '${e}')">${e}</div>`).join("")}
            <div class="emoji-item" onclick="window.toggleCustomArea()">Ôºã</div>
            ${customAreaVisible ? `<div class="custom-emoji-area"><input type="text" class="custom-input" maxlength="4" placeholder="Enter" onkeydown="if(event.key==='Enter') window.setEmoji('${type}', ${targetId}, this.value)" autofocus></div>` : ''}
        </div>`;
    };

    window.addCategory = () => {
        window.data.push({id:Date.now(),name:"Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™",emoji:"üìù",folders:[],glossary:[]});
        window.save(); window.render();
    };

    // --- „É°„Ç§„É≥„É¨„É≥„ÉÄ„É™„É≥„Ç∞ ---
    window.render = () => {
        // Â∑¶ÂÅ¥„Ç´„ÉÜ„Ç¥„É™
        document.getElementById("catList").innerHTML = window.data.map((c, cIdx)=>`
            <div class="cat-item-wrapper">
                <button class="mainBtn ${c.id===activeCatId?'active-cat':''}" onclick="window.selectCat(${c.id})" ondblclick="event.stopPropagation(); window.data[${cIdx}].editing=true; window.render();">
                    <span class="emoji-disp" onclick="window.togglePicker(event, ${c.id})">${c.emoji || 'üìù'}</span>
                    ${activePickerId === c.id ? window.getEmojiPickerHtml('cat', c.id) : ''}
                    ${c.editing?`<input class="inlineEdit" value="${c.name}" onkeydown="if(event.key==='Enter'){window.data[${cIdx}].name=this.value; window.data[${cIdx}].editing=false; window.save(); window.render();}" onblur="window.data[${cIdx}].name=this.value; window.data[${cIdx}].editing=false; window.save(); window.render();" autofocus onclick="event.stopPropagation()">`:c.name}
                    <div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data = window.data.filter(x=>x.id!==${c.id}); if(activeCatId===${c.id}) activeCatId=null; window.save(); window.render();">üóë</div></div>
                </button>
                <div class="move-btns">
                    <button class="arrowBtn" onclick="let t=window.data[${cIdx}]; window.data[${cIdx}]=window.data[${cIdx}-1]; window.data[${cIdx}-1]=t; window.save(); window.render();" ${cIdx===0?'disabled':''}>‚ñ≤</button>
                    <button class="arrowBtn" onclick="let t=window.data[${cIdx}]; window.data[${cIdx}]=window.data[${cIdx}+1]; window.data[${cIdx}+1]=t; window.save(); window.render();" ${cIdx===window.data.length-1?'disabled':''}>‚ñº</button>
                </div>
            </div>`).join("");

        const mainContainer = document.getElementById("main");
        const glossaryContainer = document.getElementById("glossary");
        const cIdx = window.data.findIndex(c => c.id === activeCatId);
        if(cIdx === -1){ mainContainer.innerHTML="<p style='color:#ccc;text-align:center;margin-top:50px;'>„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>"; glossaryContainer.innerHTML=""; return; }
        let cat = window.data[cIdx];

        // „É°„Ç§„É≥„Ç®„É™„Ç¢
        mainContainer.innerHTML = `
            <div class="active-cat-title">${cat.name}</div>
            <div class="panel">
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'char',name:'„Ç≠„É£„É©„ÇØ„Çø„Éº',emoji:'üë§',editing:false,collapsed:false,notes:[],items:[]}); window.save(); window.render();">Ôºã„Ç≠„É£„É©</button>
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'folder',name:'„Éï„Ç©„É´„ÉÄ',emoji:'üìÅ',editing:false,collapsed:false,notes:[],items:[]}); window.save(); window.render();">Ôºã„Éï„Ç©„É´„ÉÄ</button>
            </div>
            ${cat.folders.map((f, fIdx)=>`
                <div class="folder">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="nameBtn" style="margin-bottom:10px; flex:1;" onclick="window.data[${cIdx}].folders[${fIdx}].collapsed=!window.data[${cIdx}].folders[${fIdx}].collapsed; window.render();" ondblclick="event.stopPropagation(); window.data[${cIdx}].folders[${fIdx}].editing=true; window.render();">
                            <span class="emoji-disp" onclick="window.togglePicker(event, ${f.id})">${f.emoji || (f.type==='char'?'üë§':'üìÅ')}</span>
                            ${activePickerId === f.id ? window.getEmojiPickerHtml('folder', f.id) : ''}
                            ${f.editing?`<input class="inlineEdit" value="${f.name}" onkeydown="if(event.key==='Enter'){window.data[${cIdx}].folders[${fIdx}].name=this.value; window.data[${cIdx}].folders[${fIdx}].editing=false; window.save(); window.render();}" onblur="window.data[${cIdx}].folders[${fIdx}].name=this.value; window.data[${cIdx}].folders[${fIdx}].editing=false; window.save(); window.render();" autofocus onclick="event.stopPropagation()">`:f.name}
                            <div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].folders.splice(${fIdx},1); window.save(); window.render();">üóë</div></div>
                        </button>
                        <div class="move-btns" style="margin-bottom:10px;">
                            <button class="arrowBtn" onclick="window.moveFolder(${cIdx}, ${fIdx}, -1)" ${fIdx===0?'disabled':''}>‚ñ≤</button>
                            <button class="arrowBtn" onclick="window.moveFolder(${cIdx}, ${fIdx}, 1)" ${fIdx===cat.folders.length-1?'disabled':''}>‚ñº</button>
                        </div>
                    </div>
                    <div style="display:${f.collapsed?'none':'block'};">
                        <textarea id="note-input-${f.id}" placeholder="Êñ∞Ë¶è„É°„É¢„ÇíÂÖ•Âäõ..."></textarea>
                        <button class="saveNoteBtn" onclick="const v=document.getElementById('note-input-${f.id}').value; if(v){window.data[${cIdx}].folders[${fIdx}].notes.push({id:Date.now(),text:v,open:false,editing:false}); window.save(); window.render();}">‰øùÂ≠ò</button>
                        <div style="margin-top:8px;">${f.notes.map((n, nIdx)=>`
                            <div class="fullContent-wrapper">
                                ${n.editing ? `<textarea onblur="window.data[${cIdx}].folders[${fIdx}].notes[${nIdx}].editing=false; window.data[${cIdx}].folders[${fIdx}].notes[${nIdx}].text=this.value; window.save(); window.render();" autofocus>${n.text}</textarea>` :
                                (!n.open?`<button class="previewBtn" onclick="window.data[${cIdx}].folders[${fIdx}].notes[${nIdx}].open=true; window.render();">${n.text.slice(0,30)}...</button>`:`<div class="fullContent" onclick="window.data[${cIdx}].folders[${fIdx}].notes[${nIdx}].open=false; window.render();">${n.text}</div>`)}
                                <div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].folders[${fIdx}].notes.splice(${nIdx},1); window.save(); window.render();">üóë</div><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].folders[${fIdx}].notes[${nIdx}].editing=true; window.render();">‚úèÔ∏è</div></div>
                            </div>`).join("")}</div>
                        ${f.type==='char'?`<div style="margin-top:16px; border-top:1px solid #ddd; padding-top:10px;"><button class="addBtn" onclick="window.toggleAddItem(${f.id})">ÔºãË©≥Á¥∞Ë®≠ÂÆö</button>
                            ${addingItemFolderId===f.id?`<div style="background:#eee;padding:10px;border-radius:12px;margin:8px 0;"><input id="new-name-${f.id}" placeholder="È†ÖÁõÆÂêç"><textarea id="new-text-${f.id}" placeholder="ÂÜÖÂÆπ"></textarea><button class="saveNoteBtn" onclick="window.saveCharItem(${cIdx}, ${fIdx}, ${f.id})">‰øùÂ≠ò</button></div>`:''}
                            <div class="charRow">${f.items.map((i, iIdx)=>`<div class="charItem"><button class="nameBtn" onclick="window.toggleItemOpen(${cIdx}, ${fIdx}, ${iIdx})">${i.name}<div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].folders[${fIdx}].items.splice(${iIdx},1); window.save(); window.render();">üóë</div></div></button>${i.open?`<div class="fullContent" onclick="window.toggleItemOpen(${cIdx}, ${fIdx}, ${iIdx})">${i.text}</div>`:''}</div>`).join("")}</div></div>`:""}
                    </div>
                </div>`).join("")}`;

        // Âè≥ÂÅ¥Áî®Ë™ûÈõÜ (Á∑®ÈõÜ„Éú„Çø„É≥Ê©üËÉΩËøΩÂä†)
        if(!cat.glossary) cat.glossary = [];
        glossaryContainer.innerHTML = `<div style="font-size:20px;margin-bottom:16px;border-bottom:2px solid #eee;padding-bottom:8px;">üìñ Áî®Ë™ûÈõÜ</div>
            <div style="background:#eee;padding:10px;border-radius:12px;margin-bottom:16px;"><input id="new-term-name" placeholder="Áî®Ë™ûÂêç"><textarea id="new-term-desc" placeholder="Ë™¨Êòé" style="height:50px;"></textarea><button class="addBtn" style="width:100%;margin-top:8px;" onclick="window.addGlossary(${cIdx})">ËøΩÂä†</button></div>
            ${cat.glossary.map((t, tIdx)=>`
            <div class="term-wrapper">
                <button class="termBtn" onclick="window.toggleGlossaryOpen(${cIdx}, ${tIdx})">${t.name}<div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].glossary.splice(${tIdx},1); window.save(); window.render();">üóë</div></div></button>
                ${t.open ? (t.editing ? 
                    `<textarea onblur="window.data[${cIdx}].glossary[${tIdx}].editing=false; window.data[${cIdx}].glossary[${tIdx}].desc=this.value; window.save(); window.render();" autofocus>${t.desc}</textarea>` :
                    `<div class="term-desc" onclick="window.toggleGlossaryOpen(${cIdx}, ${tIdx})">${t.desc}
                        <div class="actionGroup">
                            <div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].glossary[${tIdx}].editing=true; window.render();">‚úèÔ∏è</div>
                        </div>
                    </div>`
                ) : ''}
            </div>`).join("")}`;
    };

    // --- „É≠„Ç∏„ÉÉ„ÇØÈñ¢Êï∞ ---
    window.selectCat = (id) => { activeCatId = id; window.render(); };
    window.toggleAddItem = (id) => { addingItemFolderId = (addingItemFolderId === id ? null : id); window.render(); };
    window.toggleItemOpen = (cIdx, fIdx, iIdx) => { window.data[cIdx].folders[fIdx].items[iIdx].open = !window.data[cIdx].folders[fIdx].items[iIdx].open; window.render(); };
    window.toggleGlossaryOpen = (cIdx, tIdx) => { window.data[cIdx].glossary[tIdx].open = !window.data[cIdx].glossary[tIdx].open; window.render(); };

    window.moveFolder = (cIdx, fIdx, direction) => {
        const folders = window.data[cIdx].folders;
        const targetIdx = fIdx + direction;
        if (targetIdx < 0 || targetIdx >= folders.length) return;
        [folders[fIdx], folders[targetIdx]] = [folders[targetIdx], folders[fIdx]];
        window.save(); window.render();
    };

    window.saveCharItem = (cIdx, fIdx, fId) => {
        const n = document.getElementById(`new-name-${fId}`).value;
        const t = document.getElementById(`new-text-${fId}`).value;
        if(n){ window.data[cIdx].folders[fIdx].items.push({id:Date.now(),name:n,text:t,open:false}); addingItemFolderId = null; window.save(); window.render(); }
    };
    window.addGlossary = (cIdx) => {
        const n = document.getElementById('new-term-name').value;
        const d = document.getElementById('new-term-desc').value;
        if(n){ window.data[cIdx].glossary.push({id:Date.now(),name:n,desc:d,open:false,editing:false}); window.save(); window.render(); }
    };
</script>
</body>
</html>
