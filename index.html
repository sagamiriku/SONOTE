<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONOTE - Cloud Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic:wght@700&family=Jost:wght@900&display=swap" rel="stylesheet">
    <style>
        /* „Çπ„Çø„Ç§„É´Á∂≠ÊåÅ„ÉªÂæÆË™øÊï¥ */
        body{margin:0;font-family:"Sawarabi Gothic";font-weight:700;background:#fff;overflow:hidden;}
        header { font-family: "Jost"; font-size: 34px; padding: 12px 24px; border-bottom: 1px solid #eee; background: #fff; display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
        .header-left { display: flex; align-items: baseline; gap: 10px; }
        .sync-status { font-size: 10px; font-family: "Sawarabi Gothic"; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #888; font-weight: 700; line-height: 1; transform: translateY(-2px); }
        .logout-btn { background: #eee; border: none; border-radius: 6px; padding: 4px 8px; font-size: 12px; cursor: pointer; font-family: inherit; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-btn { background: #4285F4; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(66,133,244,0.3); }
        .layout{display:flex;height:calc(100vh - 70px);width: 100vw;}
        .left{width:15%; min-width:180px; border-right:1px solid #eee; padding:16px; background:#fafafa; overflow:auto; box-sizing: border-box;}
        .main{width:50%; min-width:350px; padding:28px; overflow:auto; border-right:1px solid #eee; box-sizing: border-box;}
        .right{width:35%; min-width:250px; padding:16px; background:#fcfcfc; overflow:auto; box-sizing: border-box;}
        .active-cat-title { text-align: left; font-size: 28px; margin-bottom: 24px; color: #333; border-left: 8px solid #f6f6f6; padding: 0 0 0 16px; line-height: 1.2; }
        .panel{background:#eee;border-radius:14px;padding:10px;margin-bottom:12px;display:flex;gap:8px; flex-wrap: wrap;}
        .addBtn{background:#555;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
        .mainBtn, .nameBtn, .saveNoteBtn, .previewBtn, .boxBtn { background:#fff; border:2px solid #000; border-radius:12px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; position:relative !important; text-align:left; font-family:inherit; display: flex; align-items: center; gap: 8px; word-break: break-all; white-space: normal; overflow-wrap: break-word; }
        .mainBtn { padding-right: 34px; margin: 4px; width: calc(100% - 8px); box-sizing: border-box;}
        .box-container { border: 2px dashed #ccc; border-radius: 18px; padding: 12px; margin-bottom: 20px; background: #fff; position: relative;}
        .boxBtn { background: #000 !important; color: #fff !important; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
        .emoji-disp { font-size: 1.2em; cursor: pointer; transition: 0.2s; padding: 2px; border-radius: 4px; flex-shrink: 0; }
        .emoji-picker { position: absolute; top: 40px; left: 0; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .emoji-item { cursor: pointer; font-size: 18px; text-align: center; padding: 4px; border-radius: 6px; }
        .actionGroup { position:absolute; top: 2px; right: 2px; display:flex; flex-direction:row; gap:2px; opacity:0; transition:0.2s; z-index:20; }
        .mainBtn:hover .actionGroup, .nameBtn:hover .actionGroup, .boxBtn:hover .actionGroup, .previewBtn:hover .actionGroup, .fullContent-wrapper:hover .actionGroup, .term-wrapper:hover .actionGroup, .term-desc:hover .actionGroup { opacity:1; }
        .miniBtn { padding:2px 6px; border:2px solid #000; background:#fff; border-radius:6px; font-size:12px; cursor:pointer; line-height:1.2; color: #000; }
        .active-cat { background: #f6f6f6 !important; border-color: #000; }
        .arrowBtn { background: transparent; border: none; cursor: pointer; font-size: 16px; padding: 0 4px; color: #aaa; transition: 0.2s; }
        .arrowBtn:hover { color: #000; }
        .folder{background:#f6f6f6; border:none; border-radius:16px; padding:14px; margin-bottom:16px; display: block; overflow: visible; position: relative;}
        textarea,input{width:100%;border:2px solid #000;border-radius:12px;padding:8px;margin-top:6px;box-sizing:border-box;font-family:inherit;font-weight:700;}
        .fullContent { font-size:14px; white-space:pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; cursor: pointer; min-height:1.2em; position:relative;}
        .previewBtn { width:100%; margin-top:4px; padding:8px 34px 8px 12px; font-size:13px; border:none; text-align: left;}
        .term-wrapper { margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; position: relative; }
        .term-desc { font-size: 14px; white-space: pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; margin: 4px 0 0 0; cursor: pointer; line-height: 1.4; color: #444; word-break: break-all; min-height: 1.2em; position: relative;}
        /* ÁßªÂãïÁî®„Çª„É¨„ÇØ„Çø„Éº */
        .move-selector { background:#fff; border:2px solid #000; border-radius:12px; padding:10px; margin:8px 0; font-size:13px; }
    </style>
</head>
<body onclick="window.closeAllPickers()">

<div id="auth-overlay">
    <header style="border:none; font-size: 48px;">SONOTE</header>
    <button class="login-btn" onclick="window.login()">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</button>
</div>

<header>
    <div class="header-left">SONOTE<span id="header-status" class="sync-status">Connecting...</span></div>
    <button class="logout-btn" onclick="window.logout()">Logout</button>
</header>

<div class="layout">
    <div class="left"><div class="panel"><button class="addBtn" onclick="window.addCategory()">ÔºãËøΩÂä†</button></div><div id="catList"></div></div>
    <div class="main" id="main"></div>
    <div class="right" id="glossary"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPYhwYgFtr5pp8PYjtUMfCP541NoAmmcM",
        authDomain: "sonote-cba11.firebaseapp.com",
        projectId: "sonote-cba11",
        storageBucket: "sonote-cba11.firebasestorage.app",
        messagingSenderId: "41068766709",
        appId: "1:41068766709:web:be0782bb13591ebc74acbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    let docRef = null;

    window.data = [];
    let activeCatId = null;
    let addingItemFolderId = null;
    let activePickerId = null;
    let customAreaVisible = false;
    let movingFolderId = null; // ÁßªÂãï‰∏≠„ÅÆ„Éï„Ç©„É´„ÉÄID

    window.login = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
    window.logout = () => signOut(auth).then(() => { location.reload(); });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            docRef = doc(db, "users", user.uid);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().sonoteData;
                    if (cloudData && cloudData.length > 0 && JSON.stringify(window.data) !== JSON.stringify(cloudData)) {
                        window.data = cloudData;
                        window.render();
                        document.getElementById('header-status').innerText = "Cloud";
                    }
                }
            });
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().sonoteData) { window.data = docSnap.data().sonoteData; }
            window.render();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    window.save = async function() {
        if (!docRef) return;
        try {
            await setDoc(docRef, { sonoteData: window.data }, { merge: true });
            document.getElementById('header-status').innerText = "Cloud Synced";
        } catch (e) { document.getElementById('header-status').innerText = "Sync Error"; }
    };

    window.closeAllPickers = () => { activePickerId = null; customAreaVisible = false; window.render(); };
    window.togglePicker = (e, id) => { e.stopPropagation(); activePickerId = (activePickerId === id) ? null : id; window.render(); };

    // „Éï„Ç©„É´„ÉÄHTMLÁîüÊàê
    window.getFolderHtml = (f, fIdx, listRefPath, isInsideBox) => {
        const listStr = listRefPath;
        const catIdx = window.data.findIndex(c => c.id === activeCatId);
        return `
        <div class="folder">
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="nameBtn" style="flex:1;" onclick="${listStr}[${fIdx}].collapsed=!${listStr}[${fIdx}].collapsed; window.render();" ondblclick="event.stopPropagation(); ${listStr}[${fIdx}].editing=true; window.render();">
                    <span class="emoji-disp" onclick="window.togglePicker(event, ${f.id})">${f.emoji || (f.type==='char'?'üë§':'üìÅ')}</span>
                    ${activePickerId === f.id ? `
                        <div class="emoji-picker" onclick="event.stopPropagation()">
                            ${["üìù","üìÅ","üë§","üí°","üî•","‚≠ê","üîë","üåà","üõ°Ô∏è","üß™","üì¶"].map(e => `<div class="emoji-item" onclick="const target=window.data.find(c=>c.id===${activeCatId}); (function findAndSet(l){for(let i of l){if(i.id===${f.id}){i.emoji='${e}';return true;}if(i.folders && findAndSet(i.folders)) return true; if(i.boxes && findAndSet(i.boxes)) return true;}})(window.data); window.save(); window.render();">${e}</div>`).join("")}
                        </div>` : ''}
                    ${f.editing?`<input class="inlineEdit" value="${f.name}" onblur="${listStr}[${fIdx}].name=this.value; ${listStr}[${fIdx}].editing=false; window.save(); window.render();" autofocus>`:f.name}
                    <div class="actionGroup">
                        ${!isInsideBox ? `<div class="miniBtn" onclick="event.stopPropagation(); window.toggleMoveMode(${f.id})">üöö</div>` : ''}
                        <div class="miniBtn" onclick="event.stopPropagation(); ${listStr}.splice(${fIdx},1); window.save(); window.render();">üóë</div>
                    </div>
                </button>
            </div>
            ${movingFolderId === f.id ? `
                <div class="move-selector">
                    ÁßªÂãïÂÖà„ÇíÈÅ∏Êäû:
                    ${window.data[catIdx].boxes.map((b, bIdx) => `<button class="miniBtn" style="margin-left:5px;" onclick="window.moveFolderToBox(${fIdx}, ${bIdx})">${b.name}</button>`).join("")}
                    <button class="miniBtn" style="background:#eee;" onclick="window.toggleMoveMode(null)">ÂèñÊ∂à</button>
                </div>` : ''}
            <div style="display:${f.collapsed?'none':'block'}; margin-top:10px;">
                <textarea id="note-in-${f.id}" placeholder="„É°„É¢..."></textarea>
                <button class="saveNoteBtn" onclick="const v=document.getElementById('note-in-${f.id}').value; if(v){${listStr}[${fIdx}].notes.push({id:Date.now(),text:v,open:false}); window.save(); window.render();}">‰øùÂ≠ò</button>
                <div style="margin-top:8px;">${f.notes.map((n, nIdx)=>`
                    <div class="fullContent-wrapper" style="position:relative; margin-bottom:5px;">
                        ${n.editing ? `<textarea onblur="${listStr}[${fIdx}].notes[${nIdx}].editing=false; ${listStr}[${fIdx}].notes[${nIdx}].text=this.value; window.save(); window.render();" autofocus>${n.text}</textarea>` :
                        (!n.open?`<button class="previewBtn" onclick="${listStr}[${fIdx}].notes[${nIdx}].open=true; window.render();">${n.text.slice(0,30)}...</button>`:`<div class="fullContent" onclick="${listStr}[${fIdx}].notes[${nIdx}].open=false; window.render();">${n.text}</div>`)}
                        <div class="actionGroup"><div class="miniBtn" onclick="${listStr}[${fIdx}].notes.splice(${nIdx},1); window.save(); window.render();">üóë</div><div class="miniBtn" onclick="${listStr}[${fIdx}].notes[${nIdx}].editing=true; window.render();">‚úèÔ∏è</div></div>
                    </div>`).join("")}</div>
            </div>
        </div>`;
    };

    window.toggleMoveMode = (id) => { movingFolderId = id; window.render(); };

    window.moveFolderToBox = (folderIdx, boxIdx) => {
        const catIdx = window.data.findIndex(c => c.id === activeCatId);
        const folder = window.data[catIdx].folders.splice(folderIdx, 1)[0];
        window.data[catIdx].boxes[boxIdx].folders.push(folder);
        movingFolderId = null;
        window.save();
        window.render();
    };

    window.render = () => {
        const catListDiv = document.getElementById("catList");
        catListDiv.innerHTML = window.data.map((c, cIdx)=>`
            <div class="cat-item-wrapper">
                <button class="mainBtn ${c.id===activeCatId?'active-cat':''}" onclick="window.selectCat(${c.id})">
                    <span>${c.emoji || 'üìù'} ${c.name}</span>
                    <div class="actionGroup"><div class="miniBtn" onclick="window.data.splice(${cIdx},1); window.save(); window.render();">üóë</div></div>
                </button>
            </div>`).join("");

        const mainContainer = document.getElementById("main");
        const glossaryContainer = document.getElementById("glossary");
        const cIdx = window.data.findIndex(c => c.id === activeCatId);
        if(cIdx === -1){ mainContainer.innerHTML="<p style='color:#ccc;text-align:center;'>„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû</p>"; return; }
        
        const cat = window.data[cIdx];
        if(!cat.boxes) cat.boxes = [];
        if(!cat.folders) cat.folders = [];

        mainContainer.innerHTML = `
            <div class="active-cat-title">${cat.name}</div>
            <div class="panel">
                <button class="addBtn" onclick="window.data[${cIdx}].boxes.push({id:Date.now(),name:'Êñ∞Ë¶èBOX',folders:[]}); window.save(); window.render();">ÔºãBOX</button>
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'char',name:'„Ç≠„É£„É©',notes:[],items:[]}); window.save(); window.render();">Ôºã„Ç≠„É£„É©</button>
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'folder',name:'„Éï„Ç©„É´„ÉÄ',notes:[],items:[]}); window.save(); window.render();">Ôºã„Éï„Ç©„É´„ÉÄ</button>
            </div>
            ${cat.boxes.map((b, bIdx)=>`
                <div class="box-container">
                    <button class="boxBtn" onclick="window.data[${cIdx}].boxes[${bIdx}].collapsed=!window.data[${cIdx}].boxes[${bIdx}].collapsed; window.render();">
                        üì¶ ${b.name}
                        <div class="actionGroup"><div class="miniBtn" onclick="window.data[${cIdx}].boxes.splice(${bIdx},1); window.save(); window.render();">üóë</div></div>
                    </button>
                    <div style="display:${b.collapsed?'none':'block'};">
                        ${b.folders.map((f, fIdx) => window.getFolderHtml(f, fIdx, `window.data[${cIdx}].boxes[${bIdx}].folders`, true)).join("")}
                    </div>
                </div>
            `).join("")}
            ${cat.folders.map((f, fIdx)=> window.getFolderHtml(f, fIdx, `window.data[${cIdx}].folders`, false)).join("")}`;

        // Áî®Ë™ûÈõÜ
        if(!cat.glossary) cat.glossary = [];
        glossaryContainer.innerHTML = `<div>üìñ Áî®Ë™ûÈõÜ</div>
            <input id="gt-n" placeholder="Áî®Ë™ûÂêç"><textarea id="gt-d" placeholder="Ë™¨Êòé"></textarea>
            <button class="addBtn" style="width:100%" onclick="window.addG(${cIdx})">ËøΩÂä†</button>
            ${cat.glossary.map((t, tIdx)=>`
            <div class="term-wrapper">
                <button class="termBtn" style="width:100%" onclick="window.data[${cIdx}].glossary[${tIdx}].open=!window.data[${cIdx}].glossary[${tIdx}].open; window.render();">${t.name}</button>
                ${t.open ? `<div class="term-desc">${t.desc}<div class="actionGroup"><div class="miniBtn" onclick="window.data[${cIdx}].glossary[${tIdx}].editing=true; window.render();">‚úèÔ∏è</div></div></div>` : ''}
            </div>`).join("")}`;
    };

    window.addCategory = () => { window.data.push({id:Date.now(),name:"Êñ∞Ë¶è",folders:[],boxes:[],glossary:[]}); window.save(); window.render(); };
    window.selectCat = (id) => { activeCatId = id; window.render(); };
    window.addG = (cIdx) => {
        const n = document.getElementById('gt-n').value;
        const d = document.getElementById('gt-d').value;
        if(n){ window.data[cIdx].glossary.push({id:Date.now(),name:n,desc:d,open:false}); window.save(); window.render(); }
    };
</script>
</body>
</html>
