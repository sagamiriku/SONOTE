<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONOTE - Cloud Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic:wght@700&family=Jost:wght@900&display=swap" rel="stylesheet">
    <style>
        /* Âü∫Êú¨„Çπ„Çø„Ç§„É´ */
        body{margin:0;font-family:"Sawarabi Gothic";font-weight:700;background:#fff;overflow:hidden;}
        header { font-family: "Jost"; font-size: 34px; padding: 12px 24px; border-bottom: 1px solid #eee; background: #fff; display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
        .header-left { display: flex; align-items: baseline; gap: 10px; }
        .sync-status { font-size: 10px; font-family: "Sawarabi Gothic"; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #888; font-weight: 700; line-height: 1; transform: translateY(-2px); }
        .logout-btn { background: #eee; border: none; border-radius: 6px; padding: 4px 8px; font-size: 12px; cursor: pointer; font-family: inherit; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-btn { background: #4285F4; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(66,133,244,0.3); }
        .layout{display:flex;height:calc(100vh - 70px);width: 100vw;}
        .left{width:15%; min-width:180px; border-right:1px solid #eee; padding:16px; background:#fafafa; overflow:auto; box-sizing: border-box;}
        .main{width:50%; min-width:350px; padding:28px; overflow:auto; border-right:1px solid #eee; box-sizing: border-box;}
        .right{width:35%; min-width:250px; padding:16px; background:#fcfcfc; overflow:auto; box-sizing: border-box;}
        .active-cat-title { text-align: left; font-size: 28px; margin-bottom: 24px; color: #333; border-left: 8px solid #f6f6f6; padding: 0 0 0 16px; line-height: 1.2; }
        .panel{background:#eee;border-radius:14px;padding:10px;margin-bottom:12px;display:flex;gap:8px; flex-wrap: wrap;}
        .addBtn{background:#555;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
        .mainBtn, .nameBtn, .saveNoteBtn, .previewBtn, .boxBtn { background:#fff; border:2px solid #000; border-radius:12px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; position:relative !important; text-align:left; font-family:inherit; display: flex; align-items: center; gap: 8px; word-break: break-all; white-space: normal; overflow-wrap: break-word; }
        .mainBtn { padding-right: 34px; margin: 4px; width: calc(100% - 8px); box-sizing: border-box;}
        .box-container { border: 2px dashed #ccc; border-radius: 18px; padding: 12px; margin-bottom: 20px; background: #fff; position: relative;}
        .boxBtn { background: #000 !important; color: #fff !important; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
        .emoji-disp { font-size: 1.2em; cursor: pointer; transition: 0.2s; padding: 2px; border-radius: 4px; flex-shrink: 0; }
        .emoji-picker { position: absolute; top: 40px; left: 0; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .emoji-item { cursor: pointer; font-size: 18px; text-align: center; padding: 4px; border-radius: 6px; }
        .actionGroup { position:absolute; top: 2px; right: 2px; display:flex; flex-direction:row; gap:2px; opacity:0; transition:0.2s; z-index:20; }
        .mainBtn:hover .actionGroup, .nameBtn:hover .actionGroup, .boxBtn:hover .actionGroup, .previewBtn:hover .actionGroup { opacity:1; }
        .miniBtn { padding:2px 6px; border:2px solid #000; background:#fff; border-radius:6px; font-size:12px; cursor:pointer; line-height:1.2; color: #000; }
        .active-cat { background: #f6f6f6 !important; border-color: #000; }
        .folder{background:#f6f6f6; border:none; border-radius:16px; padding:14px; margin-bottom:16px; display: block; overflow: visible; position: relative;}
        textarea,input{width:100%;border:2px solid #000;border-radius:12px;padding:8px;margin-top:6px;box-sizing:border-box;font-family:inherit;font-weight:700;}
        .inlineEdit { border:2px solid #000; border-radius:8px; padding:4px; font-weight:700; width:80%; margin:0; }
        .fullContent { font-size:14px; white-space:pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; cursor: pointer; min-height:1.2em; position:relative;}
        .previewBtn { width:100%; margin-top:4px; padding:8px 34px 8px 12px; font-size:13px; border:none; text-align: left;}
        .move-selector { background:#fff; border:2px solid #000; border-radius:12px; padding:10px; margin:8px 0; font-size:13px; color: #000; }
    </style>
</head>
<body onclick="window.closeAllPickers()">

<div id="auth-overlay">
    <header style="border:none; font-size: 48px;">SONOTE</header>
    <button class="login-btn" onclick="window.login()">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</button>
</div>

<header>
    <div class="header-left">SONOTE<span id="header-status" class="sync-status">Connecting...</span></div>
    <button class="logout-btn" onclick="window.logout()">Logout</button>
</header>

<div class="layout">
    <div class="left"><div class="panel"><button class="addBtn" onclick="window.addCategory()">ÔºãËøΩÂä†</button></div><div id="catList"></div></div>
    <div class="main" id="main"></div>
    <div class="right" id="glossary"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPYhwYgFtr5pp8PYjtUMfCP541NoAmmcM",
        authDomain: "sonote-cba11.firebaseapp.com",
        projectId: "sonote-cba11",
        storageBucket: "sonote-cba11.firebasestorage.app",
        messagingSenderId: "41068766709",
        appId: "1:41068766709:web:be0782bb13591ebc74acbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    let docRef = null;

    window.data = [];
    let activeCatId = null;
    let activePickerId = null;
    let movingFolderId = null;
    const EMOJI_LIST = ["üìù","üìÅ","üë§","üí°","üî•","‚≠ê","üîë","üåà","üõ°Ô∏è","üß™","üìú","üó∫Ô∏è","üé≠","üíé","‚åõ","üì¶"];

    window.login = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
    window.logout = () => signOut(auth).then(() => { location.reload(); });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            docRef = doc(db, "users", user.uid);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().sonoteData;
                    if (cloudData && JSON.stringify(window.data) !== JSON.stringify(cloudData)) {
                        window.data = cloudData; window.render();
                        document.getElementById('header-status').innerText = "Cloud";
                    }
                }
            });
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().sonoteData) { window.data = docSnap.data().sonoteData; }
            window.render();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    window.save = async function() {
        if (!docRef) return;
        try {
            await setDoc(docRef, { sonoteData: window.data }, { merge: true });
            document.getElementById('header-status').innerText = "Cloud Synced";
        } catch (e) { document.getElementById('header-status').innerText = "Sync Error"; }
    };

    window.closeAllPickers = () => { activePickerId = null; window.render(); };
    window.togglePicker = (e, id) => { e.stopPropagation(); activePickerId = (activePickerId === id) ? null : id; window.render(); };

    // ÁµµÊñáÂ≠ó„Çª„ÉÉ„ÉàÁî®„Éò„É´„Éë„Éº
    window.setEmoji = (id, emoji) => {
        const findAndSet = (list) => {
            for(let item of list){
                if(item.id === id){ item.emoji = emoji; return true; }
                if(item.boxes && findAndSet(item.boxes)) return true;
                if(item.folders && findAndSet(item.folders)) return true;
            }
        };
        findAndSet(window.data); window.save(); activePickerId = null; window.render();
    };

    window.getPicker = (id) => `
        <div class="emoji-picker" onclick="event.stopPropagation()">
            ${EMOJI_LIST.map(e => `<div class="emoji-item" onclick="window.setEmoji(${id}, '${e}')">${e}</div>`).join("")}
        </div>`;

    // „Éï„Ç©„É´„ÉÄ„Éª„Ç≠„É£„É©HTMLÁîüÊàê
    window.getFolderHtml = (f, fIdx, listStr, isInsideBox) => {
        const catIdx = window.data.findIndex(c => c.id === activeCatId);
        return `
        <div class="folder">
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="nameBtn" style="flex:1;" onclick="${listStr}[${fIdx}].collapsed=!${listStr}[${fIdx}].collapsed; window.render();" ondblclick="event.stopPropagation(); ${listStr}[${fIdx}].editing=true; window.render();">
                    <span class="emoji-disp" onclick="window.togglePicker(event, ${f.id})">${f.emoji || (f.type==='char'?'üë§':'üìÅ')}</span>
                    ${activePickerId === f.id ? window.getPicker(f.id) : ''}
                    ${f.editing?`<input class="inlineEdit" value="${f.name}" onblur="${listStr}[${fIdx}].name=this.value; ${listStr}[${fIdx}].editing=false; window.save(); window.render();" autofocus onclick="event.stopPropagation()">`:f.name}
                    <div class="actionGroup">
                        ${!isInsideBox ? `<div class="miniBtn" onclick="event.stopPropagation(); movingFolderId=${f.id}; window.render();">üöö</div>` : ''}
                        <div class="miniBtn" onclick="event.stopPropagation(); ${listStr}.splice(${fIdx},1); window.save(); window.render();">üóë</div>
                    </div>
                </button>
            </div>
            ${movingFolderId === f.id ? `
                <div class="move-selector">
                    ÁßªÂãïÂÖà: ${window.data[catIdx].boxes.map((b, bIdx) => `<button class="miniBtn" style="margin-left:5px;" onclick="const folder=window.data[${catIdx}].folders.splice(${fIdx},1)[0]; window.data[${catIdx}].boxes[${bIdx}].folders.push(folder); movingFolderId=null; window.save(); window.render();">${b.name}</button>`).join("")}
                    <button class="miniBtn" style="background:#eee;" onclick="movingFolderId=null; window.render();">ÂèñÊ∂à</button>
                </div>` : ''}
            <div style="display:${f.collapsed?'none':'block'}; margin-top:10px;">
                <textarea id="ni-${f.id}" placeholder="„É°„É¢..."></textarea>
                <button class="saveNoteBtn" onclick="const v=document.getElementById('ni-${f.id}').value; if(v){${listStr}[${fIdx}].notes.push({id:Date.now(),text:v}); window.save(); window.render();}">‰øùÂ≠ò</button>
                <div style="margin-top:8px;">${f.notes.map((n, nIdx)=>`
                    <div style="position:relative; margin-bottom:5px;">
                        ${n.editing ? `<textarea onblur="${listStr}[${fIdx}].notes[${nIdx}].editing=false; ${listStr}[${fIdx}].notes[${nIdx}].text=this.value; window.save(); window.render();" autofocus>${n.text}</textarea>` :
                        (!n.open?`<button class="previewBtn" onclick="${listStr}[${fIdx}].notes[${nIdx}].open=true; window.render();">${n.text.slice(0,30)}...</button>`:`<div class="fullContent" onclick="${listStr}[${fIdx}].notes[${nIdx}].open=false; window.render();">${n.text}</div>`)}
                        <div class="actionGroup"><div class="miniBtn" onclick="${listStr}[${fIdx}].notes.splice(${nIdx},1); window.save(); window.render();">üóë</div><div class="miniBtn" onclick="${listStr}[${fIdx}].notes[${nIdx}].editing=true; window.render();">‚úèÔ∏è</div></div>
                    </div>`).join("")}</div>
            </div>
        </div>`;
    };

    window.render = () => {
        const catListDiv = document.getElementById("catList");
        catListDiv.innerHTML = window.data.map((c, cIdx)=>`
            <div class="cat-item-wrapper">
                <button class="mainBtn ${c.id===activeCatId?'active-cat':''}" onclick="activeCatId=${c.id}; window.render();" ondblclick="window.data[${cIdx}].editing=true; window.render();">
                    <span class="emoji-disp" onclick="window.togglePicker(event, ${c.id})">${c.emoji || 'üìù'}</span>
                    ${activePickerId === c.id ? window.getPicker(c.id) : ''}
                    ${c.editing?`<input class="inlineEdit" value="${c.name}" onblur="window.data[${cIdx}].name=this.value; window.data[${cIdx}].editing=false; window.save(); window.render();" autofocus onclick="event.stopPropagation()">`:c.name}
                    <div class="actionGroup"><div class="miniBtn" onclick="window.data.splice(${cIdx},1); window.save(); window.render();">üóë</div></div>
                </button>
            </div>`).join("");

        const main = document.getElementById("main");
        const cIdx = window.data.findIndex(c => c.id === activeCatId);
        if(cIdx === -1){ main.innerHTML="„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû"; return; }
        const cat = window.data[cIdx];
        if(!cat.boxes) cat.boxes = []; if(!cat.folders) cat.folders = [];

        main.innerHTML = `
            <div class="active-cat-title">${cat.name}</div>
            <div class="panel">
                <button class="addBtn" onclick="window.data[${cIdx}].boxes.push({id:Date.now(),name:'Êñ∞Ë¶èBOX',emoji:'üì¶',folders:[]}); window.save(); window.render();">ÔºãBOX</button>
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'char',name:'„Ç≠„É£„É©',emoji:'üë§',notes:[]}); window.save(); window.render();">Ôºã„Ç≠„É£„É©</button>
                <button class="addBtn" onclick="window.data[${cIdx}].folders.push({id:Date.now(),type:'folder',name:'„Éï„Ç©„É´„ÉÄ',emoji:'üìÅ',notes:[]}); window.save(); window.render();">Ôºã„Éï„Ç©„É´„ÉÄ</button>
            </div>
            ${cat.boxes.map((b, bIdx)=>`
                <div class="box-container">
                    <button class="boxBtn" onclick="window.data[${cIdx}].boxes[${bIdx}].collapsed=!window.data[${cIdx}].boxes[${bIdx}].collapsed; window.render();" ondblclick="event.stopPropagation(); window.data[${cIdx}].boxes[${bIdx}].editing=true; window.render();">
                        <span class="emoji-disp" onclick="window.togglePicker(event, ${b.id})">${b.emoji || 'üì¶'}</span>
                        ${activePickerId === b.id ? window.getPicker(b.id) : ''}
                        ${b.editing?`<input class="inlineEdit" style="color:#000" value="${b.name}" onblur="window.data[${cIdx}].boxes[${bIdx}].name=this.value; window.data[${cIdx}].boxes[${bIdx}].editing=false; window.save(); window.render();" autofocus onclick="event.stopPropagation()">`:b.name}
                        <div class="actionGroup"><div class="miniBtn" onclick="event.stopPropagation(); window.data[${cIdx}].boxes.splice(${bIdx},1); window.save(); window.render();">üóë</div></div>
                    </button>
                    <div style="display:${b.collapsed?'none':'block'};">
                        <div class="panel" style="background:#f9f9f9;"><button class="addBtn" onclick="window.data[${cIdx}].boxes[${bIdx}].folders.push({id:Date.now(),type:'char',name:'ÂÜÖ„Ç≠„É£„É©',emoji:'üë§',notes:[]}); window.save(); window.render();">ÔºãÂÜÖ„Ç≠„É£„É©</button></div>
                        ${b.folders.map((f, fIdx) => window.getFolderHtml(f, fIdx, `window.data[${cIdx}].boxes[${bIdx}].folders`, true)).join("")}
                    </div>
                </div>`).join("")}
            ${cat.folders.map((f, fIdx)=> window.getFolderHtml(f, fIdx, `window.data[${cIdx}].folders`, false)).join("")}`;

        // Áî®Ë™ûÈõÜ
        const right = document.getElementById("glossary");
        if(!cat.glossary) cat.glossary = [];
        right.innerHTML = `<div>üìñ Áî®Ë™ûÈõÜ</div>
            <input id="gt-n" placeholder="Âêç"><textarea id="gt-d" placeholder="Ë™¨"></textarea><button class="addBtn" onclick="const n=document.getElementById('gt-n').value; if(n){window.data[${cIdx}].glossary.push({id:Date.now(),name:n,desc:document.getElementById('gt-d').value}); window.save(); window.render();}">ËøΩÂä†</button>
            ${cat.glossary.map((t, tIdx)=>`<div class="term-wrapper"><button class="termBtn" style="width:100%" onclick="window.data[${cIdx}].glossary[${tIdx}].open=!window.data[${cIdx}].glossary[${tIdx}].open; window.render();">${t.name}</button>${t.open ? `<div class="term-desc">${t.desc}</div>` : ''}</div>`).join("")}`;
    };

    window.addCategory = () => { window.data.push({id:Date.now(),name:"Êñ∞Ë¶è",emoji:"üìù",folders:[],boxes:[],glossary:[]}); window.save(); window.render(); };
</script>
</body>
</html>
