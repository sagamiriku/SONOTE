<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SONOTE - Secure Cloud</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic:wght@700&family=Jost:wght@900&display=swap" rel="stylesheet">
    <style>
        /* --- „Éá„Ç∂„Ç§„É≥ --- */
        body{margin:0;font-family:"Sawarabi Gothic";font-weight:700;background:#fff;overflow:hidden;}
        header{font-family:"Jost"; font-size:34px; padding:12px 24px; border-bottom:1px solid #eee; background:#fff; display: flex; align-items: baseline; gap: 10px;}
        .sync-status { font-size: 10px; font-family: "Sawarabi Gothic"; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #888; transform: translateY(-2px); }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-btn { background: #4285F4; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .layout{display:flex;height:calc(100vh - 70px);width: 100vw;}
        .left{width:15%; min-width:180px; border-right:1px solid #eee; padding:16px; background:#fafafa; overflow:auto; box-sizing: border-box;}
        .main{width:50%; min-width:350px; padding:28px; overflow:auto; border-right:1px solid #eee; box-sizing: border-box;}
        .right{width:35%; min-width:250px; padding:16px; background:#fcfcfc; overflow:auto; box-sizing: border-box;}
        .active-cat-title { text-align: left; font-size: 28px; margin-bottom: 24px; color: #333; border-left: 8px solid #f6f6f6; padding: 0 0 0 16px; line-height: 1.2; }
        .panel{background:#eee;border-radius:14px;padding:10px;margin-bottom:12px;display:flex;gap:8px; flex-wrap: wrap;}
        .addBtn{background:#555;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
        .mainBtn, .nameBtn, .saveNoteBtn, .folderBtn, .previewBtn { background:#fff; border:2px solid #000; border-radius:12px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; position:relative; text-align:left; font-family:inherit; display: flex; align-items: center; gap: 8px; }
        .mainBtn { padding-right: 34px; margin: 4px; width: calc(100% - 8px); box-sizing: border-box;}
        .active-cat { background: #f6f6f6 !important; border-color: #000; }
        .emoji-disp { font-size: 1.2em; cursor: pointer; }
        .emoji-picker { position: absolute; top: 40px; left: 0; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; z-index: 100; }
        .emoji-item { cursor: pointer; font-size: 18px; text-align: center; padding: 4px; }
        .actionGroup { position:absolute; top:-8px; right:-8px; display:flex; flex-direction:column; gap:2px; opacity:0; transition:0.2s; z-index:20; }
        .mainBtn:hover .actionGroup, .nameBtn:hover .actionGroup, .folderBtn:hover .actionGroup, .previewBtn:hover .actionGroup, .fullContent-wrapper:hover .actionGroup, .term-wrapper:hover .actionGroup, .term-desc:hover .actionGroup, .fullContent:hover .actionGroup { opacity:1; }
        .miniBtn { padding:2px 6px; border:2px solid #000; background:#fff; border-radius:6px; font-size:14px; cursor:pointer; }
        .folder{background:#f6f6f6; border-radius:16px; padding:14px; margin-bottom:16px;}
        textarea,input{width:100%;border:2px solid #000;border-radius:12px;padding:8px;margin-top:6px;box-sizing:border-box;font-family:inherit;font-weight:700;}
        .fullContent { font-size:14px; white-space:pre-wrap; border-left: 4px solid #000; padding: 4px 16px; cursor: pointer; position:relative;}
        .previewBtn { width:100%; margin-top:4px; padding:8px 12px; font-size:13px; border:none; text-align: left;}
        .charItem { position: relative; margin-bottom: 10px; }
        .termBtn { width: auto; border: none; background: transparent; padding: 4px 0px; font-size: 15px; color: #333; display: block; text-align: left; }
        .term-desc { font-size: 14px; white-space: pre-wrap; border-left: 4px solid #000; padding: 0px 12px; margin: 4px 0; color: #444; }
    </style>
</head>
<body onclick="window.closeAllPickers()">

<div id="auth-overlay">
    <header style="border:none; font-size: 48px;">SONOTE</header>
    <button class="login-btn" onclick="window.login()">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</button>
</div>

<header>SONOTE<span id="header-status" class="sync-status">Wait...</span></header>

<div class="layout">
    <div class="left"><div class="panel"><button class="addBtn" onclick="window.addCategory()">ÔºãËøΩÂä†</button></div><div id="catList"></div></div>
    <div class="main" id="main"></div>
    <div class="right" id="glossary"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPYhwYgFtr5pp8PYjtUMfCP541NoAmmcM",
        authDomain: "sonote-cba11.firebaseapp.com",
        projectId: "sonote-cba11",
        storageBucket: "sonote-cba11.firebasestorage.app",
        messagingSenderId: "41068766709",
        appId: "1:41068766709:web:be0782bb13591ebc74acbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    let docRef = null;

    // --- ÂÖ®ÂüüÈñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© ---
    window.login = () => signInWithPopup(auth, provider).catch(err => alert(err.message));

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            docRef = doc(db, "users", user.uid);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data().sonoteData;
                    if (JSON.stringify(window.data) !== JSON.stringify(cloudData)) {
                        window.data = cloudData || [];
                        window.render();
                        document.getElementById('header-status').innerText = "Cloud";
                    }
                }
            });
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { window.data = docSnap.data().sonoteData || []; }
            window.render();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    window.save = async function() {
        if (!docRef) return;
        try {
            await setDoc(docRef, { sonoteData: window.data }, { merge: true });
            document.getElementById('header-status').innerText = "Cloud Synced";
        } catch (e) { document.getElementById('header-status').innerText = "Sync Error"; }
    };

    // --- „Ç¢„Éó„É™„ÅÆ„É°„Ç§„É≥„É≠„Ç∏„ÉÉ„ÇØ ---
    window.data = [];
    let activeCatId = null;
    let activePickerId = null;
    const EMOJI_LIST = ["üìù","üìÅ","üë§","üí°","üî•","‚≠ê","üîë","üåà","üõ°Ô∏è","üß™","üìú","üó∫Ô∏è","üé≠","üíé","‚åõ"];

    window.closeAllPickers = () => { activePickerId = null; window.render(); };
    window.togglePicker = (e, id) => { e.stopPropagation(); activePickerId = (activePickerId === id) ? null : id; window.render(); };
    window.setEmoji = (type, id, emoji) => {
        if(type === 'cat'){
            const target = window.data.find(c => c.id === id);
            if(target) target.emoji = emoji;
        } else {
            const cat = window.data.find(c => c.id === activeCatId);
            const folder = cat.folders.find(f => f.id === id);
            if(folder) folder.emoji = emoji;
        }
        activePickerId = null; window.save(); window.render();
    };

    window.addCategory = () => {
        window.data.push({id:Date.now(),name:"„Ç´„ÉÜ„Ç¥„É™",emoji:"üìù",folders:[],glossary:[]});
        window.save(); window.render();
    };

    window.render = () => {
        const catList = document.getElementById("catList");
        catList.innerHTML = window.data.map((c, idx) => `
            <div class="cat-item-wrapper">
                <button class="mainBtn ${c.id === activeCatId ? 'active-cat' : ''}" onclick="window.selectCat(${c.id})">
                    <span onclick="window.togglePicker(event, ${c.id})">${c.emoji || 'üìù'}</span>
                    ${activePickerId === c.id ? `<div class="emoji-picker">${EMOJI_LIST.map(e => `<span class="emoji-item" onclick="window.setEmoji('cat', ${c.id}, '${e}')">${e}</span>`).join("")}</div>` : ''}
                    ${c.name}
                    <div class="actionGroup"><div class="miniBtn" onclick="window.delCat(event, ${idx})">üóë</div></div>
                </button>
            </div>`).join("");

        const main = document.getElementById("main");
        const glossary = document.getElementById("glossary");
        const cat = window.data.find(c => c.id === activeCatId);
        if(!cat) { main.innerHTML = "„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"; glossary.innerHTML = ""; return; }

        main.innerHTML = `<div class="active-cat-title">${cat.name}</div>
            <div class="panel">
                <button class="addBtn" onclick="window.addFolder('char')">Ôºã„Ç≠„É£„É©</button>
                <button class="addBtn" onclick="window.addFolder('folder')">Ôºã„Éï„Ç©„É´„ÉÄ</button>
            </div>
            ${cat.folders.map((f, fIdx) => `
                <div class="folder">
                    <div class="nameBtn">
                        <span onclick="window.togglePicker(event, ${f.id})">${f.emoji || (f.type==='char'?'üë§':'üìÅ')}</span>
                        ${activePickerId === f.id ? `<div class="emoji-picker">${EMOJI_LIST.map(e => `<span class="emoji-item" onclick="window.setEmoji('folder', ${f.id}, '${e}')">${e}</span>`).join("")}</div>` : ''}
                        ${f.name}
                    </div>
                    <textarea id="in-${f.id}" placeholder="„É°„É¢..."></textarea>
                    <button class="addBtn" onclick="window.addNote(${fIdx}, ${f.id})">‰øùÂ≠ò</button>
                    ${f.notes.map(n => `<div class="fullContent">${n.text}</div>`).join("")}
                </div>`).join("")}`;
    };

    window.selectCat = (id) => { activeCatId = id; window.render(); };
    window.delCat = (e, idx) => { e.stopPropagation(); window.data.splice(idx,1); window.save(); window.render(); };
    window.addFolder = (type) => {
        const cat = window.data.find(c => c.id === activeCatId);
        cat.folders.push({id:Date.now(), type, name: type==='char'?'Êñ∞„Ç≠„É£„É©':'Êñ∞„Éï„Ç©„É´„ÉÄ', notes:[], items:[]});
        window.save(); window.render();
    };
    window.addNote = (fIdx, fId) => {
        const val = document.getElementById(`in-${fId}`).value;
        if(!val) return;
        const cat = window.data.find(c => c.id === activeCatId);
        cat.folders[fIdx].notes.push({text: val});
        window.save(); window.render();
    };
</script>
</body>
</html>
