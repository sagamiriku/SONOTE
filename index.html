<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SONOTE - Secure</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link href="https://fonts.googleapis.com/css2?family=Sawarabi+Gothic:wght@700&family=Jost:wght@900&display=swap" rel="stylesheet">
<style>
/* --- æ—¢å­˜ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç¶™æ‰¿ã—ã¤ã¤ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  --- */
body{margin:0;font-family:"Sawarabi Gothic";font-weight:700;background:#fff;overflow:hidden;}
header{
    font-family:"Jost"; font-size:34px; padding:12px 24px; border-bottom:1px solid #eee; background:#fff;
    display: flex; align-items: baseline; gap: 10px;
}
.sync-status { font-size: 10px; font-family: "Sawarabi Gothic"; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #888; transform: translateY(-2px); }

/* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#auth-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: #fff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.login-btn { 
    background: #4285F4; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; 
    font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(66,133,244,0.3);
}

/* ä»¥ä¸‹ã€æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆçœç•¥ã›ãšã«ãã®ã¾ã¾ä¿æŒã—ã¦ãã ã•ã„ï¼‰ */
.layout{display:flex;height:calc(100vh - 70px);width: 100vw;}
.left{width:15%; min-width:180px; border-right:1px solid #eee; padding:16px; background:#fafafa; overflow:auto; box-sizing: border-box;}
.main{width:50%; min-width:350px; padding:28px; overflow:auto; border-right:1px solid #eee; box-sizing: border-box;}
.right{width:35%; min-width:250px; padding:16px; background:#fcfcfc; overflow:auto; box-sizing: border-box;}
.active-cat-title { text-align: left; font-size: 28px; margin-bottom: 24px; color: #333; border-left: 8px solid #f6f6f6; padding: 0 0 0 16px; line-height: 1.2; }
.panel{background:#eee;border-radius:14px;padding:10px;margin-bottom:12px;display:flex;gap:8px; flex-wrap: wrap;}
.addBtn{background:#555;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
.mainBtn, .nameBtn, .saveNoteBtn, .folderBtn, .previewBtn { background:#fff; border:2px solid #000; border-radius:12px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; position:relative; text-align:left; font-family:inherit; display: flex; align-items: center; gap: 8px; word-break: break-all; white-space: normal; overflow-wrap: break-word; }
.mainBtn { padding-right: 34px; margin: 4px; width: calc(100% - 8px); box-sizing: border-box;}
.emoji-disp { font-size: 1.2em; cursor: pointer; transition: 0.2s; padding: 2px; border-radius: 4px; flex-shrink: 0; }
.emoji-picker { position: absolute; top: 40px; left: 0; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.emoji-item { cursor: pointer; font-size: 18px; text-align: center; padding: 4px; border-radius: 6px; }
.actionGroup { position:absolute; top:-8px; right:-8px; display:flex; flex-direction:column; gap:2px; opacity:0; transition:0.2s; z-index:20; }
.mainBtn:hover .actionGroup, .nameBtn:hover .actionGroup, .folderBtn:hover .actionGroup, .previewBtn:hover .actionGroup, .fullContent-wrapper:hover .actionGroup, .term-wrapper:hover .actionGroup, .term-desc:hover .actionGroup, .fullContent:hover .actionGroup { opacity:1; }
.miniBtn { padding:2px 6px; border:2px solid #000; background:#fff; border-radius:6px; font-size:14px; cursor:pointer; line-height:1.2; }
.active-cat { background: #f6f6f6 !important; border-color: #000; }
.cat-item-wrapper { position: relative; margin-bottom: 12px; }
.move-btns { display: flex; gap: 6px; padding-left: 8px; margin-top: 2px; }
.arrowBtn { background: transparent; border: none; cursor: pointer; font-size: 16px; padding: 0 4px; color: #aaa; }
.folder{background:#f6f6f6; border:none; border-radius:16px; padding:14px; margin-bottom:16px; display: block; overflow: visible; cursor: grab;}
.folderBtn { width: fit-content; max-width: 100%; display: flex; padding-right: 34px; margin-bottom:10px;}
.nameBtn { width: fit-content; padding-right: 34px; display: inline-flex; align-items: center; max-width: 100%;}
textarea,input{width:100%;border:2px solid #000;border-radius:12px;padding:8px;margin-top:6px;box-sizing:border-box;font-family:inherit;font-weight:700;}
.inlineEdit { border:2px solid #000; border-radius:8px; padding:4px; font-weight:700; width:80%; margin:0; }
.fullContent-wrapper { position: relative; width: 100%; margin: 8px 0; }
.fullContent { font-size:14px; white-space:pre-wrap; border-left: 4px solid #000; padding: 4px 34px 4px 16px; cursor: pointer; min-height:1.2em; position:relative;}
.previewBtn { width:100%; margin-top:4px; padding:8px 34px 8px 12px; font-size:13px; border:none; text-align: left;}
.charRow{display:flex; flex-direction: column; gap:12px; margin-top:12px;}
.charItem { position: relative; margin-bottom: 10px; }
.term-wrapper { margin-bottom: 12px; width: 100%; box-sizing: border-box; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; display: block; }
.termBtn { width: auto; border: none; background: transparent; border-radius: 0; padding: 4px 0px; font-size: 15px; color: #333; display: block; text-align: left; }
.term-desc { font-size: 14px; white-space: pre-wrap; border-left: 4px solid #000; padding: 0px 12px; margin: 4px 0 0 0; cursor: pointer; position: relative; line-height: 1.4; color: #444; font-weight: 700; text-align: left; display: block; width: fit-content; max-width: 100%; word-break: break-all; min-height: 0; }
</style>
</head>
<body onclick="closeAllPickers()">

<div id="auth-overlay">
    <header style="border:none; font-size: 48px;">SONOTE</header>
    <p style="margin-bottom: 24px; color: #666;">Cloud Sync Enabled</p>
    <button class="login-btn" onclick="login()">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<header>
    SONOTE
    <span id="header-status" class="sync-status">Wait...</span>
</header>

<div class="layout">
    <div class="left"><div class="panel"><button class="addBtn" onclick="addCategory()">ï¼‹è¿½åŠ </button></div><div id="catList"></div></div>
    <div class="main" id="main" ondragover="initDragOver(event)"></div>
    <div class="right" id="glossary"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPYhwYgFtr5pp8PYjtUMfCP541NoAmmcM",
  authDomain: "sonote-cba11.firebaseapp.com",
  projectId: "sonote-cba11",
  storageBucket: "sonote-cba11.firebasestorage.app",
  messagingSenderId: "41068766709",
  appId: "1:41068766709:web:be0782bb13591ebc74acbc",
  measurementId: "G-GSFVSPG173"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let docRef = null;

// ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°ã‚’å…¬é–‹
window.login = () => {
    signInWithPopup(auth, provider).catch(err => alert("Login Error: " + err.message));
};

// èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
        document.getElementById('auth-overlay').style.display = 'none';
        docRef = doc(db, "users", user.uid); // ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®IDã‚’ä½¿ç”¨
        
        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸèª­ã¿è¾¼ã¿ã¨ç›£è¦–ã‚’é–‹å§‹
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const cloudData = docSnap.data().sonoteData;
                if (JSON.stringify(data) !== JSON.stringify(cloudData)) {
                    data = cloudData || [];
                    render();
                    document.getElementById('header-status').innerText = "Cloud";
                }
            }
        });

        // åˆå›ãƒ­ãƒ¼ãƒ‰ï¼ˆå‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç§»è¡Œï¼‰
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            data = docSnap.data().sonoteData || [];
        } else {
            const local = localStorage.getItem("sonote_emoji_v79");
            if (local) { data = JSON.parse(local); await window.save(); }
        }
        render();
    } else {
        // æœªãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('auth-overlay').style.display = 'flex';
    }
});

// ä¿å­˜é–¢æ•°
window.save = async function() {
    if (!docRef) return;
    try {
        await setDoc(docRef, { sonoteData: data }, { merge: true });
        document.getElementById('header-status').innerText = "Cloud Synced";
    } catch (e) {
        document.getElementById('header-status').innerText = "Sync Error";
    }
};
</script>

<script>
/* --- æ—¢å­˜ã®ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãã®ã¾ã¾ï¼‰ --- */
let data = [];
let activeCatId = null;
let addingItemFolderId = null;
let activePickerId = null;
let customAreaVisible = false;
const EMOJI_LIST = ["ğŸ“","ğŸ“","ğŸ‘¤","ğŸ’¡","ğŸ”¥","â­","ğŸ”‘","ğŸŒˆ","ğŸ›¡ï¸","ğŸ§ª","ğŸ“œ","ğŸ—ºï¸","ğŸ­","ğŸ’","âŒ›"];

// ... (renderé–¢æ•°ã€addCategoryã€ãã®ä»–ãƒ­ã‚¸ãƒƒã‚¯å…¨é‡ãŒå…¥ã‚Šã¾ã™ãŒçœç•¥ãªã—ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„) ...
// â€»æ–‡å­—æ•°åˆ¶é™ã«ã‚ˆã‚Šçœç•¥ã—ã¦è¦‹ãˆã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ä»¥å‰ã®renderãƒ­ã‚¸ãƒƒã‚¯ã‚’ã™ã¹ã¦å«ã‚ã¦ãã ã•ã„ã€‚
</script>
</body>
</html>
